#!/usr/bin/env bash

# Source common
source common

###############
## Variables ##
###############

FI_DOWNLOAD_DIR="/media/shagbag913/Roms/factimages"
URL="$1"
FI_ZIP="$(basename "${URL}")"
FI_FOLDER="$(echo "${FI_ZIP}" | awk -F-factory '{print $1}')"
IMAGE_ZIP="image-${FI_FOLDER}.zip"
FI_SAVE_DIR=${FI_DOWNLOAD_DIR}/"$(echo ${FI_ZIP} | sed -n 's/-factory.*//; s/.*sailfish-//p')"

##################
# Sanity Checks ##
##################

[[ -z ${FI_SAVE_DIR} ]] && echo -e "${RED}Save location not set! Exiting...${RESTORE}" && exit 1
[[ ! -e ${FI_DOWNLOAD_DIR} ]] && echo -e "${RED}Save location ${FI_SAVE_DIR} does not exist! Exiting...${RESTORE}" && exit 1
[[ -z ${URL} ]] && echo -e "${RED}No URL specified! Exiting...${RESTORE}" && exit 1

################################
## Download the factory image ##
################################

cd ${FI_DOWNLOAD_DIR} || return
## Only download the zip if it doesn't already exist ##
if [[ ! -e ${FI_ZIP} ]]; then
    wget "${URL}"
        if [[ $? -gt 0 ]]; then
            echo -e "${RED}Download failed! Exiting...${RESTORE}" && exit 1
        fi
fi
unzip "${FI_ZIP}"
cd "${FI_FOLDER}" || return
unzip "${IMAGE_ZIP}"
## Create the save directory if it does not exist ##
[[ ! -e ${FI_SAVE_DIR} ]] && mkdir "${FI_SAVE_DIR}" && echo -e "${BLUE}Created directory ${FI_SAVE_DIR}${RESTORE}"
cp vendor.img "${FI_SAVE_DIR}/"
cp boot.img "${FI_SAVE_DIR}/"

#####################################
## Transfer images to Google Drive ##
#####################################

grive_chk
if [[ ${GDRIVE} = true ]]; then
    GD_IMAGESURL=http://gg.gg/shagbag913_images
    cp -r "${FI_SAVE_DIR}" "${GD_FOLDER}"/Images
    cd "${GD_FOLDER}" || return
    grive
    dc_chk
    if [[ ${DC} = true ]]; then
        dc_msg "**Google Drive: $(date +%B)s vendor and boot images uploaded! ${GD_IMAGESURL}**"
    fi
fi

rm -rf "${FI_DOWNLOAD_DIR:?}/${FI_ZIP}"
