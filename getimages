#!/usr/bin/env bash
source common

FI_DOWNLOAD_DIR="/media/shagbag913/Roms/factimages"
URL="$1"
FI_ZIP="$(basename "${URL}")"
FI_FOLDER="$(echo "${FI_ZIP}" | awk -F-factory '{print $1}')"
BUILD_NUM="$(echo "${FI_ZIP}" | sed -n "s/-factory.*//; s/.*${DEVICE}-//p")"
FI_SAVE_DIR=${FI_DOWNLOAD_DIR}/"${BUILD_NUM}"

[[ -z ${FI_SAVE_DIR} ]] && error "Save location not set! Exiting..."
[[ ! -e ${FI_DOWNLOAD_DIR} ]] && error "${RED}Save location ${FI_SAVE_DIR} does not exist! Exiting..."
[[ -z ${URL} ]] && error "No URL specified! Exiting..."

cd ${FI_DOWNLOAD_DIR} || return
if [[ ! -e ${FI_ZIP} ]]; then
  if ! wget "${URL}"; then error "Download failed! Exiting..."; fi
fi

unzip "${FI_ZIP}"
cd "${FI_FOLDER}" || return
unzip "image-${FI_FOLDER}.zip"
[[ ! -e ${FI_SAVE_DIR} ]] && { mkdir "${FI_SAVE_DIR}"; info "Created directory ${FI_SAVE_DIR}"; }
cp vendor.img "${FI_SAVE_DIR}/"
cp boot.img "${FI_SAVE_DIR}/"

# TRANSFER IMAGES TO GOOGLE DRIVE
grive_chk
if [[ ${GDRIVE} = true ]]; then
  GD_IMAGESURL=http://gg.gg/shagbag913_images
  cp -r "${FI_SAVE_DIR}" "${GD_FOLDER}/Images/${DEVICE}/"
  cd "${GD_FOLDER}" || return
  grive
  dc_chk
  if [[ ${DC} = true ]]; then
    dc_msg "**Google Drive: ${BUILD_NUM} vendor and boot images for ${DEVICE} uploaded! ${GD_IMAGESURL}**"
  fi
fi

# REMOVE FACTORY IMAGE ZIP
rm -rf "${FI_DOWNLOAD_DIR:?}/${FI_ZIP}"
