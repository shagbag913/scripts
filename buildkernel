#!/usr/bin/env bash
source common

if [[ ! -e Makefile ]]; then error "Not in a kernel directory! Exiting..."; fi
GCC_DIR="/media/shagbag913/Roms/kernel/toolchains/build-tools-gcc/aarch64-linux-gnu/bin/aarch64-linux-gnu-"
if [[ ! "${CCACHE_DIR}" =~ "kernel" ]]; then
  export CCACHE_DIR="${CCACHE_DIR}kernel"
fi
export ARCH=arm64

while [[ "${#}" -ge 1 ]]; do
  case "${1}" in
    "-d") DIRTY=true;;
    "-g") GCC=true;;
    "-c") CLANG=true;;
  esac
  shift
done

if [[ -z "${DIRTY}" ]]; then
  make clean
  make mrproper
  make shag_defconfig
fi

if [[ -n "${CLANG}" ]]; then
  info "Building with Clang"
  make "${PAR_THREAD}" \
    CC="ccache /media/shagbag913/Roms/kernel/toolchains/linux-x86/clang-r328903/bin/clang" \
    CLANG_TRIPLE=aarch64-linux-gnu- \
    CROSS_COMPILE="${GCC_DIR}" && SUCCESS=true
fi

if [[ -n "${GCC}" ]]; then
  info "Building with GCC"
  make "${PAR_THREAD}" \
    CROSS_COMPILE="ccache ${GCC_DIR}" && SUCCESS=true
fi

if [[ ${SUCCESS} = true ]]; then
  info "Kernel build successful!"
  cd /media/shagbag913/Roms/kernel/shagkernel/ak2 || error "Couldn't find AnyKernel2 folder!"
  cp /media/shagbag913/Roms/kernel/shagkernel/arch/arm64/boot/Image.lz4-dtb .
  ./zip.sh
  rm -rf "${GD_FOLDER}"/Kernel/*
  cp /media/shagbag913/Roms/kernel/shagkernel/ak2/ShagKernel*.zip "${GD_FOLDER}"/Kernel
  grive -p "${GD_FOLDER}" && info "Kernel uploaded to GDrive"
fi
